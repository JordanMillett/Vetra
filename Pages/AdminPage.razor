@page "/admin"
@inject HttpClient Http
@inject HelperService Helper
@inject NotificationService Notifications
@inject IJSRuntime Runtime
@using System.Text
@using System.Text.Json;

<PageTitle>Vetra - Admin</PageTitle>

<ConfirmDialog @ref="ResponsePopup" />

<h1 class="text-center"><strong>Admin Page</strong></h1>
<hr><br>

@if(DeviceEndpoint != "")
{
    <h4 class="text-center">@DeviceEndpoint</h4>
}

<div class="row text-center">
    <div class="col-4"></div>
    <div class="col-4">
        <label>Server Password</label><input type="password" @bind=@Password /><br><br>
    </div>
    <div class="col-4"></div>
</div>

<div class="buttons">
    <button class="btn" @onclick="SetAlertDevice">Set Alert Device</button>
    <button class="btn" @onclick="ClearSubscribers">Clear Subscribers</button>
    <button class="btn" @onclick="ClearLogs">Clear Logs</button>
    <button class="btn" @onclick="RestartServer">Restart Server</button>
    <button class="btn" @onclick="ShutdownServer">Shutdown Server</button>
</div>

<br>


<div class="row">
    <div class="col-md-6 col-12">
        <form @onsubmit="SendMessage">
            <label>Title</label><input type="text" @bind=@Header /><br><br>
            <label>Message</label><input type="text" @bind=@Message /><br><br>
            <button class="btn" type="submit">Send Message</button>
        </form>
    </div>
    <div class="col-md-6 col-12">
        <form @onsubmit="SetLimit">
            <label>Subscriber Limit</label><input type="number" @bind=@SubLimit /><br><br>
            <button class="btn" type="submit">Set Limit</button>
        </form>
    </div>
</div>



<br>

<div class="row">
    <div class="col-12">
        <form @onsubmit="GetLogs">
            <label>Log Count</label><input type="number" @bind=@LogCount />
            <button class="btn" type="submit">Get Logs</button>
        </form>
    </div>
    <div class="col-12">
        <textarea readonly @bind="LogText"></textarea>
    using System.Net;
    </div>
</div>

<style>
    label
    {
    margin-right:10px;
    }

    textarea
    {
    font-family: monospace;
    resize: none;
    min-width: 100%;
    height: 500px;
    }

    .buttons
    {
    border-radius: 0.5rem; /*0.5rem for --bs-border-radius-lg */
    border-style: solid;
    border-color: var(--vetra-midtone);
    border-width: 2px;
    }
</style>

@code 
{
    ConfirmDialog ResponsePopup = default!;
    ConfirmDialogOptions Options = new ConfirmDialogOptions 
    { 
        YesButtonText = "Ok", 
        NoButtonText = null!
    };

    string Header = "";
    string Message = "";
    string Password = "";
    string ResponseText = "";
    string ResponseTextDetails = "";

    string LogCount = "";
    string LogText = "";

    string SubLimit = "";

    string DeviceEndpoint = "";

    protected override async Task OnInitializedAsync()
    {
        DeviceEndpoint = await Runtime.InvokeAsync<string>("getEndpoint");
        if(DeviceEndpoint != "")
            DeviceEndpoint = DeviceEndpoint[^10..];
    }

    async Task SetAlertDevice()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Setting Alert Device Failed";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        try
        {
            AlertDeviceMessage Data = new AlertDeviceMessage
            {
                Endpoint = await Runtime.InvokeAsync<string>("getEndpoint"),
                Password = await Helper.Hash(Password)
            };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/setalertdevice", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                ResponseText = "Alert Device Set";
                ResponseTextDetails = "This device has been made the alert device.";
                Header = "";
                Message = "";
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ResponseText = "Setting Alert Device Failed";
                ResponseTextDetails = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                ResponseText = "Setting Alert Device Failed";
                ResponseTextDetails = "A server error occured.";
            }
        }
        catch
        {
            ResponseText = "Setting Alert Device Failed";
            ResponseTextDetails = "An client error occured.";
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }

    async Task GetLogs()
    {
        if (!await Notifications.ServerAlive())
        {
            LogText = "Unable to connect to VetraHub";
            return;
        }

        try
        {
            WebLogRequest Data = new WebLogRequest
                {
                    Count = int.TryParse(LogCount, out int count) ? count : 1,
                    Password = await Helper.Hash(Password)
                };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/logs", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                List<DataNotificationLog>? DownloadedLogs = await HttpResponse.Content.ReadFromJsonAsync<List<DataNotificationLog>>();

                LogText = "";

                if (DownloadedLogs != null)
                {
                    foreach (DataNotificationLog Log in DownloadedLogs)
                    {
                        string localTimeFormatted = Log.Timestamp.ToLocalTime().ToString("HH:mm:ss:fff");
                        LogText += $"[{localTimeFormatted}]\t#{Log.Id}\t{Log.Message}\n";
                    }
                }
                else
                {
                    LogText = "No logs to download";
                }
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                LogText = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                LogText = "A server error occured.";
            }
        }
        catch
        {
            LogText = "An client error occured.";
        }
    }

    async Task ClearLogs()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Clearing Logs Failed";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        try
        {
            PasswordMessage Data = new PasswordMessage
            {
                Password = await Helper.Hash(Password)
            };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/clearlogs", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                ResponseText = "Cleared Logs";
                ResponseTextDetails = "Logs cleared successfully.";
                Header = "";
                Message = "";
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ResponseText = "Clearing Logs Failed";
                ResponseTextDetails = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                ResponseText = "Clearing Logs Failed";
                ResponseTextDetails = "A server error occured.";
            }
        }
        catch
        {
            ResponseText = "Clearing Logs Failed";
            ResponseTextDetails = "An client error occured.";
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }

    async Task SetLimit()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Failed to Set Limit";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        try
        {
            SubscriberLimitMessage Data = new SubscriberLimitMessage
            {
                Limit = int.TryParse(SubLimit, out int limit) ? limit : -1,
                Password = await Helper.Hash(Password)
            };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/setlimit", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                ResponseText = "Limit Set";
                ResponseTextDetails = "Limit set successfully.";
                Header = "";
                Message = "";
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ResponseText = "Failed to Set Limit";
                ResponseTextDetails = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                ResponseText = "Failed to Set Limit";
                ResponseTextDetails = "A server error occured.";
            }
        }
        catch
        {
            ResponseText = "Failed to Set Limit";
            ResponseTextDetails = "An client error occured.";
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }

    async Task ClearSubscribers()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Clearing Subscribers Failed";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        try
        {
            PasswordMessage Data = new PasswordMessage
                {
                    Password = await Helper.Hash(Password)
                };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/clearsubscribers", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                ResponseText = "Cleared Subscribers";
                ResponseTextDetails = "Subscribers cleared successfully.";
                Header = "";
                Message = "";
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ResponseText = "Clearing Subscribers Failed";
                ResponseTextDetails = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                ResponseText = "Clearing Subscribers Failed";
                ResponseTextDetails = "A server error occured.";
            }
        }
        catch
        {
            ResponseText = "Clearing Subscribers Failed";
            ResponseTextDetails = "An client error occured.";
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }

    async Task ShutdownServer()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Shutdown Failed";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        try
        {
            PasswordMessage Data = new PasswordMessage
            {
                Password = await Helper.Hash(Password)
            };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/shutdown", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                ResponseText = "Server Shutdown";
                ResponseTextDetails = "Server shut down successfully.";
                Header = "";
                Message = "";
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ResponseText = "Server Shutdown Failed";
                ResponseTextDetails = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                ResponseText = "Server Shutdown Failed";
                ResponseTextDetails = "A server error occured.";
            }
        }
        catch
        {
            ResponseText = "Server Shutdown Failed";
            ResponseTextDetails = "An client error occured.";
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }

    async Task RestartServer()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Restart Failed";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        try
        {
            PasswordMessage Data = new PasswordMessage
            {
                Password = await Helper.Hash(Password)
            };
            HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/restart", Data);

            if (HttpResponse.IsSuccessStatusCode)
            {
                ResponseText = "Server Restarted";
                ResponseTextDetails = "Server restarted successfully.";
                Header = "";
                Message = "";
            }
            else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ResponseText = "Server Restart Failed";
                ResponseTextDetails = "Incorrect password. Please try again.";
                Password = "";
            }
            else
            {
                ResponseText = "Server Restart Failed";
                ResponseTextDetails = "A server error occured.";
            }
        }
        catch
        {
            ResponseText = "Server Restart Failed";
            ResponseTextDetails = "An client error occured.";
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }

    async Task SendMessage()
    {
        if (!await Notifications.ServerAlive())
        {
            ResponseText = "Notification Failed";
            ResponseTextDetails = "Unable to connect to VetraHub";
            await ResponsePopup.ShowAsync
            (
                title: ResponseText,
                message1: ResponseTextDetails,
                confirmDialogOptions: Options
            );
            return;
        }

        if (Header == "" || Message == "")
        {
            ResponseText = "Notification Failed";
            ResponseTextDetails = "Missing header or message.";
        }
        else
        {
            try
            {
                WebNotificationRequest Data = new WebNotificationRequest
                    {
                        Content = new WebNotificationMessage
                        {
                            Title = Header,
                            Body = Message
                        },
                        Password = await Helper.Hash(Password)
                    };
                HttpResponseMessage HttpResponse = await Http.PostAsJsonAsync("https://vetra.jordanmillett.net/api/notifications/send", Data);

                if (HttpResponse.IsSuccessStatusCode)
                {
                    ResponseText = "Notification Sent";
                    ResponseTextDetails = "Your notification was sent successfully.";
                    Header = "";
                    Message = "";
                }
                else if (HttpResponse.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    ResponseText = "Notification Failed";
                    ResponseTextDetails = "Incorrect password. Please try again.";
                    Password = "";
                }
                else
                {
                    ResponseText = "Notification Failed";
                    ResponseTextDetails = "A server error occured.";
                }
            }
            catch
            {
                ResponseText = "Notification Failed";
                ResponseTextDetails = "An client error occured.";
            }
        }

        await ResponsePopup.ShowAsync
        (
            title: ResponseText,
            message1: ResponseTextDetails,
            confirmDialogOptions: Options
        );
    }


    //SYNC ACROSS VETRA
    public class AlertDeviceMessage
    {
        public required string Endpoint { get; set; }
        public required string Password { get; set; }
    }

    public class PasswordMessage
    {
        public required string Password { get; set; }
    }

    public class SubscriberLimitMessage
    {
        public required int Limit { get; set; }
        public required string Password { get; set; }
    }

    public class WebLogRequest
    {
        public required int Count { get; set; }
        public required string Password { get; set; }
    }

    public class WebNotificationRequest
    {
        public required WebNotificationMessage Content { get; set; }
        public required string Password { get; set; }
    }

    public class WebNotificationMessage
    {
        public required string Title { get; set; }
        public required string Body { get; set; }
    }
    
    public class DataNotificationLog
    {
        public required int Id { get; set; }
        public required string Message { get; set; }
        public required DateTime Timestamp { get; set; }
    }
}